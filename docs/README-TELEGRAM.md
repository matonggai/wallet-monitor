# 📱 电报机器人通知功能

## 🎯 功能概述

您的钱包监控程序现在具备了完整的电报机器人通知功能！无论程序因为什么原因中断，您都能在电报上收到即时通知。

## 🚀 快速开始

### 1. 自动设置（推荐）
```bash
npm run setup-telegram
```
按照提示输入您的机器人Token和Chat ID即可。

### 2. 手动设置
1. 创建电报机器人（参考 `TELEGRAM_SETUP.md`）
2. 在 `.env` 文件中添加配置：
   ```bash
   TELEGRAM_BOT_TOKEN=your_bot_token_here
   TELEGRAM_CHAT_ID=your_chat_id_here
   ```
3. 测试配置：
   ```bash
   npm run test-telegram
   ```

## 📋 通知类型

### 🚀 启动通知
- **触发时机**：程序启动时
- **内容**：监控配置、地址信息、启动时间
- **重要性**：信息

### 💰 转移通知
- **触发时机**：ETH转移成功时
- **内容**：转移金额、交易哈希、Gas费用
- **重要性**：成功

### ⚠️ 警告通知
- **触发时机**：网络错误、余额不足等
- **内容**：错误详情、处理状态
- **重要性**：警告

### 🛑 停止通知（紧急）
- **触发时机**：程序异常停止时
- **内容**：停止原因、时间、紧急提醒
- **重要性**：紧急

### 🏥 健康检查
- **触发时机**：定期状态报告
- **内容**：运行状态、余额、错误计数
- **重要性**：信息

## 🔧 中断场景覆盖

### 1. 程序崩溃
- **检测**：`uncaughtException` 事件
- **通知**：立即发送紧急停止通知
- **内容**：异常详情、时间戳

### 2. 网络错误
- **检测**：RPC连接失败
- **通知**：发送警告通知
- **内容**：错误类型、重试状态

### 3. 服务器重启
- **检测**：`SIGTERM` 信号
- **通知**：发送正常停止通知
- **内容**：重启原因、时间

### 4. 手动停止
- **检测**：`SIGINT` 信号（Ctrl+C）
- **通知**：发送正常停止通知
- **内容**：手动停止确认

### 5. 内存不足
- **检测**：进程异常退出
- **通知**：发送紧急停止通知
- **内容**：系统资源问题

### 6. 网络中断
- **检测**：连续连接失败
- **通知**：发送网络错误通知
- **内容**：连接状态、重试次数

## 🛡️ 安全特性

### 1. 错误隔离
- 电报通知失败不会影响主程序
- 独立的错误处理机制
- 优雅降级

### 2. 配置验证
- 启动时验证配置
- 自动检测缺失参数
- 详细的错误提示

### 3. 消息格式
- HTML格式支持
- 表情符号增强可读性
- 结构化信息展示

## 📊 监控命令

```bash
# 启动监控程序
npm start

# 测试电报配置
npm run test-telegram

# 设置电报机器人
npm run setup-telegram

# 查看实时日志
pm2 logs wallet-monitor -f

# 查看错误日志
tail -f error.log
```

## 🔍 故障排除

### 收不到通知？
1. 运行 `npm run test-telegram` 检查配置
2. 确认向机器人发送了 `/start`
3. 检查网络连接
4. 验证Token和Chat ID

### 通知延迟？
1. 检查网络连接质量
2. 确认电报服务器状态
3. 查看程序日志

### 重复通知？
1. 检查程序是否重复启动
2. 确认PM2配置正确
3. 查看错误日志

## 🎯 高级配置

### 自定义通知格式
修改 `telegram-bot.js` 中的消息模板

### 多用户通知
在 `.env` 中配置多个Chat ID：
```bash
TELEGRAM_CHAT_ID=123456789,987654321
```

### 通知频率控制
添加环境变量：
```bash
TELEGRAM_NOTIFICATION_INTERVAL=300000  # 5分钟间隔
```

## 📱 电报消息示例

### 启动通知
```
🚀 钱包监控程序已启动

📊 监控信息：
• 监控地址: 0x1234...5678
• 安全地址: 0x8765...4321
• 检查间隔: 10000ms
• 最小金额: 0.001 ETH

🔧 配置信息：
• RPC提供商数量: 4
• 最大重试次数: 3
• 重试延迟: 5000ms

⏰ 启动时间: 2025-08-07 14:30:00
```

### 紧急停止通知
```
🚨 紧急警报

🛑 钱包监控程序已停止

📋 停止原因：
未捕获的异常: ETIMEDOUT

⏰ 停止时间: 2025-08-07 14:35:00

⚠️ 请注意：
程序停止后，钱包将不再受到监控保护！
```

## 🎉 总结

现在您的钱包监控程序具备了：

✅ **完整的通知系统** - 覆盖所有中断场景  
✅ **实时监控** - 即时了解程序状态  
✅ **安全保护** - 错误隔离和优雅降级  
✅ **易于配置** - 一键设置和测试  
✅ **详细日志** - 完整的通知历史  

无论程序因为什么原因中断，您都能在电报上收到通知，确保您的资金安全！ 